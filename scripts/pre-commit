#!/bin/bash

# Pre-commit hook for strapd project
# Runs formatting, linting, and tests before allowing commit
# Only runs relevant checks based on changed files

set -e

echo "Running pre-commit checks..."

# Check what files are being committed
RUST_FILES=$(git diff --cached --name-only | grep -E '\.(rs|toml)$' | head -1)
WEBAPP_FILES=$(git diff --cached --name-only | grep '^webapp/' | head -1)

# Format code (always run since it's fast)
echo "ğŸ¨ Checking code format..."
make fmt-check

# Run linters based on changed files
echo "ğŸ” Running linter..."
if [[ -n "$RUST_FILES" && -n "$WEBAPP_FILES" ]]; then
    echo "  â†’ Running both Rust and webapp linters (mixed changes detected)"
    make lint
elif [[ -n "$RUST_FILES" ]]; then
    echo "  â†’ Running Rust linter only (Rust files changed)"
    make lint-rust
elif [[ -n "$WEBAPP_FILES" ]]; then
    echo "  â†’ Running webapp linter only (webapp files changed)"
    make webapp-lint
else
    echo "  â†’ No Rust or webapp files changed, skipping linting"
fi

# Run tests (always run for safety)
echo "ğŸ§ª Running tests..."
make test

echo "âœ… All pre-commit checks passed!"
